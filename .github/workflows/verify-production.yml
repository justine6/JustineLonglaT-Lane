name: Verify Production

on:
  workflow_run:
    workflows: ["Production (Vercel)"]
    types: [completed]
  workflow_dispatch:
    inputs:
      healthcheck_url:
        description: "Override healthcheck URL (optional)"
        required: false
        type: string

permissions:
  contents: read

concurrency:
  group: verify-production-${{ github.run_id }}
  cancel-in-progress: true

jobs:
  verify:
    if: >
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') ||
      (github.event_name == 'workflow_dispatch')
    runs-on: ubuntu-latest
    env:
      # Prefer explicit input, then repo secret, then default homepage
      HEALTHCHECK_URL: ${{ inputs.healthcheck_url || secrets.HEALTHCHECK_URL || format('https://{0}', github.repository_owner == 'justine6' && 'jutellane.com' || 'example.com') }}
      TIMEOUT_SECS: '10'
      RETRIES: '5'
      SLEEP_SECS: '5'
    steps:
      - name: Show target
        run: |
          echo "Healthcheck URL: $HEALTHCHECK_URL"
      - name: Curl with retries
        id: curl
        shell: bash
        run: |
          set -euo pipefail
          url="${HEALTHCHECK_URL}"
          retries=${RETRIES}
          timeout=${TIMEOUT_SECS}
          sleep_secs=${SLEEP_SECS}
          code=0
          for i in $(seq 1 ${retries}); do
            echo "Attempt $i/${retries} → ${url}"
            set +e
            out=$(curl -sS -m "${timeout}" -o /dev/null -w "%{http_code}" "${url}")
            rc=$?
            set -e
            if [[ $rc -eq 0 && "$out" =~ ^2[0-9][0-9]$ ]]; then
              echo "Status: $out"
              echo "http_code=$out" >> "$GITHUB_OUTPUT"
              exit 0
            fi
            echo "Non-200 or error (rc=${rc}, code=${out:-n/a}). Sleeping ${sleep_secs}s…"
            sleep "${sleep_secs}"
          done
          echo "Failed after ${retries} attempts."
          exit 1
      - name: Add summary
        if: success()
        run: |
          echo "✅ Production healthcheck passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- URL: ${{ env.HEALTHCHECK_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "- HTTP: ${{ steps.curl.outputs.http_code }}" >> $GITHUB_STEP_SUMMARY

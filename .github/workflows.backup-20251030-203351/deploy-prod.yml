name: Production

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write
  deployments: write
  pull-requests: read

concurrency:
  group: production
  cancel-in-progress: false

env:
  NODE_OPTIONS: --max-old-space-size=4096

jobs:
  build_and_deploy:
    name: Build & Deploy to Vercel
    runs-on: ubuntu-latest
    timeout-minutes: 30
    environment:
      name: production            # Approvals configured in Settings â†’ Environments â†’ production
      url: ${{ steps.deploy.outputs.prod_url }}
    outputs:
      prod_url: ${{ steps.deploy.outputs.prod_url }}
      version: ${{ steps.pkgver.outputs.version }}
      approver: ${{ steps.approver.outputs.approver }}
    env:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install
        run: npm ci

      - name: Lint
        run: npm run lint --if-present

      - name: Unit Tests
        run: npm test --if-present -- --ci

      - name: Read package.json version
        id: pkgver
        shell: bash
        run: |
          echo "version=$(node -p \"require('./package.json').version || '0.0.0'\")" >> "$GITHUB_OUTPUT"

      - name: Pull Production Env
        run: npx vercel pull --yes --environment=production --token "$VERCEL_TOKEN"

      - name: Build (Vercel)
        run: npx vercel build --token "$VERCEL_TOKEN"

      - name: Deploy (Production)
        id: deploy
        run: |
          url=$(npx vercel deploy --prebuilt --prod --token "$VERCEL_TOKEN")
          echo "prod_url=$url" >> "$GITHUB_OUTPUT"

      # âœ… Best-effort: fetch approver via Deployments API (latest status creator)
      - name: Record Approver (best-effort)
        id: approver
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const ref = context.sha;
            const env = 'production';
            const deps = await github.request('GET /repos/{owner}/{repo}/deployments', {
              owner, repo, ref, environment: env, per_page: 5
            });
            if (!deps.data.length) {
              core.setOutput('approver', '(unknown)');
              return;
            }
            const dep = deps.data[0];
            const statuses = await github.request('GET /repos/{owner}/{repo}/deployments/{deployment_id}/statuses', {
              owner, repo, deployment_id: dep.id, per_page: 10
            });
            const latest = statuses.data[0];
            const approver = (latest && latest.creator && latest.creator.login) ? latest.creator.login : '(unknown)';
            core.setOutput('approver', approver);

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: prod-build-${{ github.run_id }}
          path: .vercel/output/**

      - name: Summary
        run: |
          echo "### Production Deploy" >> "$GITHUB_STEP_SUMMARY"
          echo "URL: ${{ steps.deploy.outputs.prod_url }}" >> "$GITHUB_STEP_SUMMARY"
          echo "Commit: ${{ github.sha }}" >> "$GITHUB_STEP_SUMMARY"
          echo "Version: ${{ steps.pkgver.outputs.version }}" >> "$GITHUB_STEP_SUMMARY"
          echo "Approval: ${{ steps.approver.outputs.approver }} (best-effort)" >> "$GITHUB_STEP_SUMMARY"

      - name: Slack Notify (optional)
        if: success() && secrets.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1.27.0
        with:
          payload: |
            {"text":"ðŸš€ Production deployed: ${{ steps.deploy.outputs.prod_url }} (commit ${{ github.sha }}, version ${{ steps.pkgver.outputs.version }}, approved by ${{ steps.approver.outputs.approver }})"}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  tag_and_release:
    name: Tag & Create Release
    needs: build_and_deploy
    runs-on: ubuntu-latest
    if: needs.build_and_deploy.result == 'success'
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute release tag
        id: tag
        shell: bash
        run: |
          VERSION="${{ needs.build_and_deploy.outputs.version }}"
          SHORT_SHA="$(git rev-parse --short HEAD)"
          TAG="v${VERSION}-prod-${GITHUB_RUN_NUMBER}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "short_sha=$SHORT_SHA" >> "$GITHUB_OUTPUT"

      - name: Create tag (idempotent)
        shell: bash
        run: |
          TAG="${{ steps.tag.outputs.tag }}"
          if git ls-remote --exit-code --tags origin "refs/tags/$TAG" >/dev/null 2>&1; then
            echo "Tag exists: $TAG"
          else
            git tag -a "$TAG" -m "Production deploy: $TAG"
            git push origin "$TAG"
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: ${{ steps.tag.outputs.tag }}
          body: |
            **Production deploy**
            - URL: ${{ needs.build_and_deploy.outputs.prod_url }}
            - Commit: ${{ steps.tag.outputs.short_sha }}
            - Version: ${{ needs.build_and_deploy.outputs.version }}
            - Approved by: ${{ needs.build_and_deploy.outputs.approver }} (best-effort)
          draft: false
          prerelease: false
